# (C) 2024 GoodData Corporation

# Deploy of ui sdk examples from rel/9.9 branch
name: Doc ~ Examples deploy
on:
  workflow_dispatch:

jobs:
  build-apidocs:
    runs-on:
        group: infra1-runners-arc
        labels: runners-rxa-xlarge
    permissions:
      contents: write
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
            ref: "master"
            token: ${{ secrets.TOKEN_GITHUB_YENKINS_ADMIN }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
            repository: 'gooddata/gooddata-ui-apidocs'
            ref: 'master'
            token: ${{ secrets.TOKEN_GITHUB_YENKINS_ADMIN }}
            path: "gooddata-ui-apidocs"

      - name: Add repository to git safe directories to avoid dubious ownership issue
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Config user
        run: |
            git config --global user.email "git-action@gooddata.com"
            git config --global user.name "git-action"

            - name: Setup rush
            env:
              NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
            uses: ./gooddata-ui-sdk/.github/actions/rush/set-up-rush

      - name: Build apidocs
        run: |

              node common/scripts/install-run-rush.js build
              symlinks=$([ "$IS_NEW_LATEST" = true ] && echo "--update-symlink" || echo "")
              echo "updating symlinks: $symlinks"
              echo node common/scripts/build-docs.js -v 20.0 $symlinks
              node common/scripts/build-docs.js -v 20.0 $symlinks
        env:
          VERSION: ${{ inputs.version }}
          IS_NEW_LATEST: ${{ inputs.is-new-latest }}

      - name: Publish apidocs
        run: |
              cd gooddata-ui-apidocs
              git add --all
              git commit -m "chore: create a new api docs version $VERSION" -m "risk: nonprod"
              git show --stat

