name: rw ~ rush ~ build validate and run unit tests
on:
  workflow_call:
    inputs:
      target-branch:
          required: true
          description: "Target branch to compare with (marge into)"
          type: string


jobs:
  ######################################################
  # Warm up the cache pnmp and rush
  ######################################################
  # warm-up-cache:
  #   runs-on:
  #     group: infra1-runners-arc
  #     labels: runners-cxa-xlarge
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         ref: "test2"
  #     - name: Git config user
  #       uses: snow-actions/git-config-user@v1.0.0
  #       with:
  #         name: git-action
  #         email: git-action@gooddata.com
  #     - name: Warmup rush
  #       env:
  #         NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  #       uses: ./.github/actions/rush/warm-up-rush

  test:
    runs-on:
      group: infra1-runners-arc
      labels: runners-mxa-2xlarge #we need bigger runners
    env:
      NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      TARGET_BRANCH: ${{ inputs.target-branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: "test2"
      - name: Git config user
        uses: snow-actions/git-config-user@v1.0.0
        with:
          name: git-action
          email: git-action@gooddata.com
      - name: Setup rush
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        uses: ./.github/actions/rush/set-up-rush
      - name: fetch target branch
        run: git fetch origin ${TARGET_BRANCH}
      - name: Rush build
        run: |
          # build libs first, then the app
          node common/scripts/install-run-rush.js build
      - name: Rush test-ci
        run: |
          cd libs/sdk-ui-dashboard
          npm run test-once
