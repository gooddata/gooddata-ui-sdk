# (C) 2024 GoodData Corporation

name: Push ~ Prerelease
on:
  push:
    branches:
      - master

jobs:
  pull-request-info:
    runs-on:
      group: infra1-runners-arc
      labels: runners-small
    outputs:
      should-prerelease: ${{ steps.should-prerelease.outputs.result }}
      author: ${{ steps.author.outputs.result }}
      branch-name: ${{ steps.extract-branch.outputs.branch }}
    steps:
      - uses: actions/github-script@v7
        id: should-prerelease
        with:
          script: |
            const pullRequests = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              commit_sha: context.sha,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            return pullRequests?.data[0]?.labels?.some((it) => it.name === 'publish');
          result-encoding: string
      - uses: actions/github-script@v7
        id: author
        with:
          script: |
            const pullRequests = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              commit_sha: context.sha,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            return pullRequests?.data[0]?.user?.login;
          result-encoding: string
      - name: Extract branch name
        env:
          CURRENT_REF: ${{ github.event.ref }}
        id: extract-branch
        shell: bash
        run: echo "branch=${CURRENT_REF#refs/heads/}" >> $GITHUB_OUTPUT

  publish-pre-release:
    needs: [pull-request-info]
    name: Publish pre-release
    # should-prerelease is a string, not a boolean
    if: ${{ needs.pull-request-info.outputs.should-prerelease == 'true' }}
    uses: ./.github/workflows/rw-publish-prerelease.yml
    secrets: inherit
    permissions:
      contents: write
      id-token: write
    with:
      source-branch:  ${{ needs.pull-request-info.outputs.branch-name }}
      author-name: ${{ needs.pull-request-info.outputs.author }}

  check-new-alpha:
    needs: [publish-pre-release]
    name: Check if new alpha version
    runs-on:
      group: infra1-runners-arc
      labels: runners-small
    outputs:
      is-new-alpha: ${{ steps.check-version.outputs.is-new-alpha }}
      version: ${{ steps.check-version.outputs.version }}
    steps:
      - name: Check if version is new alpha
        id: check-version
        run: |
          VERSION="${{ needs.publish-pre-release.outputs.version }}"
          echo "Version: $VERSION"
          
          # Check if version ends with -alpha.X where X is not 0
          if [[ $VERSION =~ -alpha\.([0-9]+)$ ]]; then
            ALPHA_NUMBER="${BASH_REMATCH[1]}"
            echo "Alpha number: $ALPHA_NUMBER"
            
            if [[ $ALPHA_NUMBER != "0" ]]; then
              echo "This is a new alpha version (not .0)"
              echo "is-new-alpha=true" >> $GITHUB_OUTPUT
            else
              echo "This is the first alpha version (.0)"
              echo "is-new-alpha=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Not an alpha version"
            echo "is-new-alpha=false" >> $GITHUB_OUTPUT
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  trigger-gdc-ui-backport:
    needs: [check-new-alpha, pull-request-info]
    name: Trigger gdc-ui backport
    if: ${{ needs.check-new-alpha.outputs.is-new-alpha == 'true' }}
    runs-on:
      group: infra1-runners-arc
      labels: runners-small
    steps:
      - name: Trigger sdk-backport in gdc-ui
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TOKEN_GITHUB_YENKINS_ADMIN }}
          repository: gooddata/gdc-ui
          event-type: sdk-alpha-published
