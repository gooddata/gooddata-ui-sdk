# (C) 2024 GoodData Corporation

name: rw ~ Release ~ Publish release
on:
  workflow_call:
    inputs:
      bump:
        required: true
        description: "The type of version bump (major, minor, patch)"
        type: string

# limit concurrency to one run per branch at a time
# so that we can run this from master and a release branch at the same time
# When a concurrent job or workflow is queued,
# if another job or workflow using the same concurrency group in the repository is in progress,
# the queued job or workflow will be pending. Any previously pending job or workflow in the concurrency group will be canceled.
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  bump-version:
    uses: ./.github/workflows/rw-bump-version.yml
    permissions:
      contents: write
      id-token: write
    secrets: inherit
    with:
      source-branch: "release"
      bump: ${{ inputs.bump }}

  publish-release:
    needs: [bump-version]
    uses: ./.github/workflows/rw-publish-version.yml
    permissions:
      contents: read
      id-token: write
    secrets: inherit
    with:
      source-branch: "release"
      release-tag: "latest"

  add-release-tag:
    needs: [publish-release, bump-version]
    uses: ./.github/workflows/rw-git-create-tag.yml
    permissions:
      contents: write
    with:
      source-branch: "release"
      version: ${{ needs.bump-version.outputs.version }}

  create-rel-branch:
    runs-on: [ubuntu-latest]
    needs: [add-release-tag,bump-version]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Create release name
        id: create_release_name
        run: |
          string=${{needs.bump-version.outputs.version}}
          base="rel/${string%.*}"
          echo "version $string converted to $base"
          echo "target-branch=$base" >> $GITHUB_OUTPUT
      - name: Run copy branch action
        uses: ./.github/actions/branch-cutoff-action
        with:
          source-branch: 'release'
          target-branch: ${{ steps.create_release_name.outputs.target-branch }}

  slack-notification:
    runs-on: [ubuntu-latest]
    needs: [bump-version, publish-release,add-release-tag,create-rel-branch]
    steps:
      - name: Notify to slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "#javascript-notifications"
          slack-message: "The latest *${{ env.BUMP }}* version, *gooddata-ui-sdk@${{ env.RELEASE_VERSION }}*, has been successfully published on NPM by the user *${{env.GITHUB_USER}}*. :tada:"
        env:
          RELEASE_VERSION: ${{ needs.bump-version.outputs.version }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          BUMP: ${{ inputs.bump }}
          GITHUB_USER: ${{ github.actor }}
