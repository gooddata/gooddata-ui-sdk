// (C) 2025 GoodData Corporation
@use "agVariables" as ag;

.gd-pivot-table-next {
    @include ag.ag-grid-theme-variables;

    // Align body rows with multi-row header without introducing a visual
    // gap between them:
    // - move the whole grid up by 1px
    // - move the header viewport down by 1px
    // This keeps the header in the same place relative to surrounding
    // content but closes the 1px gap above the first data row.
    margin-top: -1px;

    .ag-header-viewport {
        margin-top: 1px;
    }

    --transparent-dash-border: 1px dashed transparent;
    --dash-border: 1px dashed var(--gd-table-gridColor);
    --solid-border: 1px solid var(--gd-table-gridColor);
    --transparent-border: 1px solid transparent;
    $root: &;

    // Shared background variables for totals/subtotals
    // We take the darkest color and add transparency to get the desired lighter background color
    --overall-total-bg: var(--gd-table-overallTotalBackgroundColor);
    --subtotal-bg: color-mix(in sRGB, var(--overall-total-bg) 20%, transparent);
    --total-bg: color-mix(in sRGB, var(--overall-total-bg) 40%, transparent);
    --column-subtotal-bg: var(--subtotal-bg);
    --column-total-bg: var(--total-bg);
    --row-subtotal-column-subtotal-bg: color-mix(in sRGB, var(--overall-total-bg) 40%, transparent);
    --row-total-column-subtotal-bg: color-mix(in sRGB, var(--overall-total-bg) 60%, transparent);
    --row-subtotal-column-total-bg: color-mix(in sRGB, var(--overall-total-bg) 60%, transparent);
    --row-total-column-total-bg: color-mix(in sRGB, var(--overall-total-bg) 80%, transparent);

    width: 100%;
    height: 100%;
    position: relative;

    .ag-row {
        border: none;
    }

    .ag-cell {
        overflow: hidden;
    }

    .ag-header {
        border-bottom: none;
    }

    .ag-header-span-height {
        border-top: none;
    }

    .ag-header-row:last-child > .ag-header-cell {
        border-bottom: var(--solid-border);
    }

    [row-index="0"] {
        .ag-cell:not(.ag-cell-range-selected) {
            // stylelint-disable-next-line declaration-no-important
            border-top-color: transparent !important;
        }
    }

    .ag-header-cell,
    .ag-header-group-cell {
        border-bottom: var(--dash-border);
    }

    .ag-header-cell:hover,
    .ag-header-group-cell:hover {
        background-color: var(--gd-table-headerHoverBackgroundColor);
    }

    // Use outline (doesn't affect layout) with same thickness as cell border (1px)
    .ag-header-cell:focus-visible,
    .ag-header-cell:has(:focus-visible),
    .ag-header-group-cell:focus-visible,
    .ag-header-group-cell:has(:focus-visible) {
        outline: 1px solid var(--ag-range-selection-border-color);
        outline-offset: -1px;
        box-shadow: none; // Remove AG Grid's default focus box-shadow
    }

    .ag-header-cell-comp-wrapper {
        display: flex;
        width: 100%;
    }

    .ag-icon-none {
        display: none;
    }

    .gd-column-group-header {
        border-bottom: 1px dashed transparent;
        border-bottom-color: var(
            --gd-table-gridColor,
            var(--gd-palette-complementary-4-from-theme, rgba(176, 190, 202, 0.5))
        );
    }

    .ag-header-group-cell-with-group {
        border-left: 1px dashed transparent;
        border-left-color: var(--gd-table-gridColor);
    }

    .ag-header-row:not(:first-child) .ag-header-group-cell.ag-header-group-cell-with-group {
        border-top: var(--ag-borders-critical) var(--ag-border-color);
    }

    .ag-header-cell-wrap-text {
        .gd-header-content {
            .gd-header-text {
                white-space: unset;
                overflow: unset;
                text-overflow: unset;
            }
        }
    }

    &__header-cell {
        border: none;
        display: flex;
        width: 100%;
        align-items: center;

        .gd-header-content {
            display: flex;
            width: 100%;
            align-items: center;

            .gd-header-text {
                overflow-x: hidden;
                text-overflow: ellipsis;
                text-align: left;
                min-width: 16px;
            }

            .gd-sort-indicator {
                display: inline-flex;
                align-items: center;
                min-width: 16px;
                justify-content: flex-start;
            }

            .gd-sort-order {
                font-size: 8px;
                font-weight: 700;
                line-height: 1;
                color: var(--gd-palette-complementary-8);
            }
        }

        .gd-header-cell-clickable-area {
            position: absolute;
            inset: -300% -100%;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            z-index: 1;
        }

        &--drillable {
            font-weight: bold;
            cursor: pointer;
            color: var(--gd-table-valueColor);
        }

        &--drillable:hover {
            text-decoration: underline;
        }

        &--transposed-left-border {
            border-left: var(--dash-border);
        }

        &--metric {
            .gd-header-content {
                justify-content: flex-end;

                .gd-header-text {
                    text-align: right;
                }
            }
        }

        &--subtotal {
            font-weight: 800;
            background-color: var(--subtotal-bg);
        }

        &--total {
            font-weight: 800;
            background-color: var(--total-bg);
        }

        &--first-of-group:not(.ag-column-first) {
            // stylelint-disable-next-line declaration-no-important
            border-left: var(--dash-border) !important;
        }

        &.ag-column-first {
            border-top: none;
        }

        // Show menu button on hover or when a descendant has visible keyboard focus
        &:hover,
        &:has(:focus-visible) {
            #{$root}__header-cell-menu-button,
            #{$root}__header-cell-menu-button-wrapper {
                opacity: 1;
                pointer-events: auto;
            }

            .ag-icon-none {
                display: block;
            }

            .ag-icon-none::before {
                -webkit-mask-image: url("data:image/svg+xml,%0A%20%20%20%20%3Csvg%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M7%209.49985L10.5%204.49985H3.5L7%209.49985Z%22%20fill%3D%22%23464E56%22%2F%3E%0A%20%20%20%20%3C%2Fsvg%3E%0A");
                mask-image: url("data:image/svg+xml,%0A%20%20%20%20%3Csvg%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M7%209.49985L10.5%204.49985H3.5L7%209.49985Z%22%20fill%3D%22%23464E56%22%2F%3E%0A%20%20%20%20%3C%2Fsvg%3E%0A");
            }

            .ag-icon-asc::before {
                -webkit-mask-image: url("data:image/svg+xml,%0A%20%20%20%20%3Csvg%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M7%209.49985L10.5%204.49985H3.5L7%209.49985Z%22%20fill%3D%22%23464E56%22%2F%3E%0A%20%20%20%20%3C%2Fsvg%3E%0A");
                mask-image: url("data:image/svg+xml,%0A%20%20%20%20%3Csvg%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M7%209.49985L10.5%204.49985H3.5L7%209.49985Z%22%20fill%3D%22%23464E56%22%2F%3E%0A%20%20%20%20%3C%2Fsvg%3E%0A");
            }

            .ag-icon-desc::before {
                -webkit-mask-image: url("data:image/svg+xml,%0A%20%20%20%20%3Csvg%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M7%204.50015L10.5%209.50015H3.5L7%204.50015Z%22%20fill%3D%22%23464E56%22%2F%3E%0A%20%20%20%20%3C%2Fsvg%3E%0A");
                mask-image: url("data:image/svg+xml,%0A%20%20%20%20%3Csvg%20width%3D%2214%22%20height%3D%2214%22%20viewBox%3D%220%200%2014%2014%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%20%20%20%20%20%20%3Cpath%20d%3D%22M7%204.50015L10.5%209.50015H3.5L7%204.50015Z%22%20fill%3D%22%23464E56%22%2F%3E%0A%20%20%20%20%3C%2Fsvg%3E%0A");
            }
        }

        // Keep hover background color when menu is open
        // Apply to the parent AG Grid cell to cover the entire cell area
        &--is-menu-open {
            #{$root}__header-cell-menu-button,
            #{$root}__header-cell-menu-button-wrapper {
                opacity: 1;
                pointer-events: auto;
            }
        }
    }

    // Apply background to the entire AG Grid header cell when menu is open
    .ag-header-cell:has(#{$root}__header-cell--is-menu-open),
    .ag-header-group-cell:has(#{$root}__header-cell--is-menu-open) {
        background-color: var(--gd-table-headerHoverBackgroundColor);
    }

    &__header-cell-menu {
        display: flex;
        align-items: center;
    }

    &__header-cell-menu-button {
        display: flex;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        width: 24px;
        z-index: 2;
        flex: 0 0 auto;
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        cursor: pointer;
    }

    &__header-cell-menu-button-wrapper {
        display: flex;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        width: 24px;
        z-index: 3;
    }

    &__header-cell-menu-clickable-area {
        position: absolute;
        top: -132px;
        left: -10px;
        height: 264px;
        width: 34px;
        background: var(--gd-table-headerHoverBackgroundColor);
        z-index: -1;
        border-right: 1px solid var(--gd-palette-complementary-3);
    }

    &__header-cell-menu-button:hover {
        #{$root}__header-cell-menu-clickable-area {
            background: var(--gd-palette-primary-base-dimmed-darken03);
        }
    }

    &__header-cell-menu-section-header {
        position: relative;
        padding: 12px 10px 0;
        line-height: 16px;
        color: var(--gd-table-nullValueColor);
        font-size: 10px;
        text-transform: uppercase;
        cursor: default;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    &__header-cell-submenu-section-header {
        position: relative;
        padding: 12px 30px 0;
        line-height: 16px;
        color: var(--gd-table-nullValueColor);
        font-size: 10px;
        text-transform: uppercase;
        cursor: default;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    &__header-cell-submenu-section-icon {
        position: absolute;
        left: 10px;
        top: 12px;
    }

    // First header row
    .ag-header-row:first-child {
        #{$root}__header-cell {
            border-top: none;
        }
    }

    &__cell {
        border: var(--transparent-dash-border);
        border-top: var(--dash-border);

        &.ag-cell-range-selected {
            border-left: var(--dash-border);
        }

        &.ag-cell-range-single-cell {
            border: var(--solid-border);
            border-color: var(--ag-range-selection-border-color);
        }

        &--drillable {
            font-weight: bold;
            cursor: pointer;
            color: var(--gd-table-valueColor);
        }

        &--drillable:hover {
            text-decoration: underline;
        }

        &--attribute {
            text-align: left;

            &:not(.ag-cell-range-selected) {
                // stylelint-disable-next-line declaration-no-important
                border-left-color: transparent !important;
            }
        }

        &--metric {
            text-align: right;
        }

        &--first-of-group:not(.ag-column-first):not(.ag-cell-range-selected) {
            // stylelint-disable-next-line declaration-no-important
            border-left: var(--dash-border) !important;
        }

        &--separated:not(.ag-cell-range-selected) {
            // stylelint-disable-next-line declaration-no-important
            border-top: var(--solid-border) !important;
        }

        &--grouped:not(.ag-cell-range-selected) {
            border-color: transparent;
            // stylelint-disable-next-line declaration-no-important
            background-color: var(--gd-table-backgroundColor) !important;
        }

        &--null {
            color: var(--gd-table-nullValueColor);
        }

        &--subtotal {
            font-weight: 800;
            color: var(--gd-table-valueColor);
            background-color: var(--subtotal-bg);

            &:not(.ag-cell-range-selected) {
                // stylelint-disable-next-line declaration-no-important
                border-top: var(--solid-border) !important;
            }
        }

        &--total {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--total-bg);

            &:not(.ag-cell-range-selected) {
                // stylelint-disable-next-line declaration-no-important
                border-top: var(--solid-border) !important;
            }
        }

        &--row-subtotal {
            font-weight: 800;
            color: var(--gd-table-valueColor);
            background-color: var(--subtotal-bg);
        }

        &--row-total {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--total-bg);

            &:not(.ag-cell-range-selected) {
                // stylelint-disable-next-line declaration-no-important
                border-top: var(--solid-border) !important;
            }
        }

        &--total-header {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--total-bg);
            text-align: left;

            &:not(.ag-cell-range-selected) {
                // stylelint-disable-next-line declaration-no-important
                border-top: var(--solid-border) !important;
            }
        }

        &--subtotal-header {
            font-weight: 800;
            color: var(--gd-table-valueColor);
            background-color: var(--subtotal-bg);
        }

        &--column-total {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--column-total-bg);
            border-left: var(--solid-border);
        }

        &--column-subtotal {
            font-weight: 800;
            color: var(--gd-table-valueColor);
            background-color: var(--column-subtotal-bg);
            border-left: var(--dash-border);
        }

        &--row-subtotal-column-subtotal {
            font-weight: 800;
            color: var(--gd-table-valueColor);
            background-color: var(--row-subtotal-column-subtotal-bg);
            border-top: var(--solid-border);
        }

        &--row-total-column-subtotal {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--row-total-column-subtotal-bg);
            border-top: var(--solid-border);
            border-left: var(--dash-border);
        }

        &--row-total-column-total {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--row-total-column-total-bg);
            border-top: var(--solid-border);
            border-left: var(--solid-border);
        }

        &--row-subtotal-column-total {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--row-subtotal-column-total-bg);
            border-top: var(--solid-border);
            border-left: var(--solid-border);
        }

        &--overall-total {
            font-weight: 800;
            color: var(--gd-table-totalValueColor);
            background-color: var(--gd-table-overallTotalBackgroundColor);

            &:not(.ag-cell-range-selected) {
                // stylelint-disable-next-line declaration-no-important
                border-top: var(--solid-border) !important;
            }
        }

        &--transposed-left-border {
            border-left: var(--dash-border);
        }

        // When grand totals rows are pinned to the top, use a bottom border on the pinned cells.
        &--pinned-top {
            &:not(.ag-cell-range-selected) {
                // stylelint-disable-next-line declaration-no-important
                border-top-color: transparent !important;
                border-bottom: var(--solid-border);
            }
        }

        // For the last pinned row, reinforce the line with an inset
        // box-shadow so it stays visible even if the container clips the border.
        &--pinned-top-last {
            &:not(.ag-cell-range-selected) {
                box-shadow: inset 0 -1px 0 var(--gd-table-gridColor);
            }

            &.ag-cell-range-bottom {
                box-shadow: inset 0 -1px 0 var(--ag-range-selection-border-color);
            }
        }

        // Show measure in row header menu button
        &:hover,
        &:has(:focus-visible) {
            #{$root}__header-cell-menu-button,
            #{$root}__header-cell-menu-button-wrapper {
                opacity: 1;
                pointer-events: auto;
            }
        }
    }

    &__cell-image-wrapper {
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        min-width: 0;
        overflow: hidden;

        .ag-cell-auto-height & {
            height: auto;
            min-height: 28px;
            padding: 4px 0;
        }
    }

    &__cell-image {
        max-height: 100%;
        width: auto;
        object-fit: contain;

        .ag-cell-auto-height & {
            height: auto;
            width: auto;
            max-width: 100%;
        }
    }

    &__cell-image-empty {
        height: 100%;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    // First cell row
    .ag-row-first {
        #{$root}__cell:not(.ag-cell-range-selected) {
            border-top-color: transparent;
        }
    }

    .ag-column-first:not(.ag-cell-range-selected) {
        border-left-color: transparent;
    }

    // Pagination: hide summary, keep only page controls
    .ag-paging-panel {
        justify-content: center;

        // Hide first and last page buttons
        [data-ref="btFirst"],
        [data-ref="btLast"] {
            display: none;
        }

        // Style next and previous buttons - circular design from Figma
        [data-ref="btPrevious"],
        [data-ref="btNext"] {
            width: 22px;
            height: 22px;
            min-width: 22px;
            border: none;
            border-radius: 40px;
            background: var(--gd-palette-complementary-2);
            cursor: pointer;
            transition:
                background 0.2s ease,
                color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;

            // Default icon color
            .ag-icon {
                color: var(--gd-palette-complementary-9);
            }

            // Hover, and Selected states
            &:hover:not(.ag-disabled),
            &.ag-selected:not(.ag-disabled) {
                background: var(--gd-palette-complementary-5);

                .ag-icon {
                    color: var(--gd-palette-complementary-0);
                }
            }

            // Disabled state - must come after hover to override
            &.ag-disabled {
                cursor: not-allowed;

                .ag-icon {
                    opacity: 0.5;
                    color: var(--gd-palette-complementary-7);
                }
            }
        }

        // Page number display
        .ag-paging-page-summary-panel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--gd-spacing-10px);

            color: var(--gd-palette-complementary-9);
            font-family: var(--gd-font-family);
            font-size: 12px;
            font-style: normal;
            line-height: 14px;

            // Hide the word "Page" (first span)
            .ag-paging-description > span:first-child {
                display: none;
            }

            // Current page number should be bold
            [data-ref="lbCurrent"] {
                font-weight: 700;
            }
        }

        .ag-paging-row-summary-panel {
            display: none;
        }
    }
}
